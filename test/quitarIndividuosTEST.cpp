#include "../definiciones.h"
#include "../Funciones_TPI.h"
#include "../ejercicios.h"
#include "../auxiliares.h"
#include "gtest/gtest.h"
#include <iostream>
#include <string>

using namespace std;

TEST(quitarIndividuosTEST, SacaUnIndividuoHogaresSinModificacion) {
    eph_h th = {
        {22010,2020,3,319938,629513,1,41,0,1,4,3,2},
        {20101,2020,3,315773,625696,1,41,0,1,2,2,2},
    };

    eph_i ti = {
        {22010,2020,1,0,3,1,65,1,2,15000,8}, // este se borra
        {22010,2020,7,0,3,2,22,0,0,10000,10},
        {22010,2020,9,0,3,1,9,0,0,0,10},
        {22010,2020,10,0,3,2,9,0,0,0,10},
        {22010,2020,11,0,3,2,2,0,0,0,10},
        {22010,2020,12,0,3,2,17,0,0,0,10},
        {20101,2020,1,0,3,2,46,1,3,3900,0},  // este no se borra, que tiene el mismo nro de componente
        {20101,2020,2,0,3,1,24,0,3,6000,10},
    };

    EXPECT_TRUE(esEncuestaValida(th, ti));

    vector<pair<int, dato>> busqueda = {
        {PP04G, 8},
        {COMPONENTE, 1}
    };

    eph_h th0 = eph_h(th);
    eph_i ti0 = eph_i(ti);

    pair<eph_h, eph_i> res = quitarIndividuos(ti, th, busqueda);

    eph_h th_res = {{22010,2020,3,319938,629513,1,41,0,1,4,3,2}};
    eph_i ti_res = {{22010,2020,1,0,3,1,65,1,2,15000,8}};
    //verificacion de salida
    EXPECT_EQ(th_res, res.first);
    EXPECT_EQ(ti_res, res.second);

    // verificacion de encuesta resultante
    EXPECT_TRUE(esEncuestaValida(th,ti));
    ti0.erase(ti0.begin()); // borro el primer elemento que era el que cumplia el criterio
    // ordeno para que no importe el orden
    sort(th.begin(),th.end());
    sort(ti.begin(),ti.end());

    sort(th0.begin(),th0.end());
    sort(ti0.begin(),ti0.end());

    EXPECT_EQ(th, th0);
    EXPECT_EQ(ti, ti0);

}

TEST(quitarIndividuosTEST, SacaTodosIndividuosYHogarVacio) {
    eph_h th = {
        {22010,2020,3,319938,629513,1,41,0,1,4,3,2},
        {20101,2020,3,315773,625696,1,41,0,1,2,2,2},
    };

    eph_i ti = {
        {22010,2020,1,0,3,1,65,1,2,15000,8},
        {22010,2020,7,0,3,2,22,0,0,10000,10},
        {22010,2020,9,0,3,1,9,0,0,0,10},
        {22010,2020,10,0,3,2,9,0,0,0,10},
        {22010,2020,11,0,3,2,2,0,0,0,10},
        {22010,2020,12,0,3,2,17,0,0,0,10},
        {20101,2020,1,0,3,2,46,1,3,3900,0},
        {20101,2020,2,0,3,1,24,0,3,6000,10},
    };

    vector<pair<int, dato>> busqueda = {
        {INDCODUSU, 22010}
    };


    eph_h th_res = {
            {22010,2020,3,319938,629513,1,41,0,1,4,3,2}
    };

    eph_i ti_res = {
        {22010,2020,1,0,3,1,65,1,2,15000,8},
        {22010,2020,7,0,3,2,22,0,0,10000,10},
        {22010,2020,9,0,3,1,9,0,0,0,10},
        {22010,2020,10,0,3,2,9,0,0,0,10},
        {22010,2020,11,0,3,2,2,0,0,0,10},
        {22010,2020,12,0,3,2,17,0,0,0,10}
    };

    eph_h th_out = {
            {20101,2020,3,315773,625696,1,41,0,1,2,2,2}
    };

    eph_i ti_out = {
            {20101,2020,2,0,3,1,24,0,3,6000,10},
            {20101,2020,1,0,3,2,46,1,3,3900,0},
    };

    pair<eph_h, eph_i> res = quitarIndividuos(ti, th, busqueda);

    // verificacion de encuesta resultante
    EXPECT_TRUE(esEncuestaValida(th,ti));
    //verificacion de salida de hogares (un solo elemento)
    EXPECT_EQ(th_res, res.first);
    EXPECT_EQ(th_out, th);

    // verificacion de salida de individuos (varios elementos)
    // ordeno para que no importe el orden
    sort(ti_out.begin(),ti_out.end());

    EXPECT_EQ(ti, ti_out);
}

TEST(quitarIndividuosTEST, quitarUnIndividuoDeUnHogarBusquedaDeMuchosItems) {

    eph_h th = {
            {15726,2018,3,336630,646391,2,40,1,1,3,3,2},
            {188,  2018,3,325187,635309,3,40,0,1,3,2,2},
            {8596, 2018,3,336582,646678,2,40,1,1,1,1,2},
            {11867,2018,3,320329,630940,1,43,1,1,3,2,2}
    };

    eph_h th_esperado = {
            {15726,2018,3,336630,646391,2,40,1,1,3,3,2},
            {188,  2018,3,325187,635309,3,40,0,1,3,2,2},
            {11867,2018,3,320329,630940,1,43,1,1,3,2,2}
    };


    eph_i ti = {
            {15726,2018,1,0,3,2,50,1,3,10000,0},
            {15726,2018,2,0,3,1,47,1,3,10000,5},
            {15726,2018,3,1,3,1,27,1,1,18000,8},
            {15726,2018,4,0,3,1,26,1,3,16000,5},
            {15726,2018,5,0,3,2,19,0,0,0,    10},
            {15726,2018,6,1,3,2,3, 0,0,0,     10}, //cumple condicion
            {188,  2018,1,1,3,2,60,0,0,6000,  10}, //cumple condicion
            {188,  2018,2,0,3,1,71,0,0,7000,  10},
            {188,  2018,3,1,3,1,39,1,2,2000,  9},
            {188,  2018,4,0,3,1,36,0,0,0,     10},
            {188,  2018,5,0,3,1,29,1,2,1000,  8},
            {188,  2018,6,0,3,1,10,0,0,0,     10},
            {8596, 2018,1,1,3,2,56,1,3,18000, 10}, //cumple condicion
            {11867,2018,1,1,3,1,26,1,3,21000, 1},
            {11867,2018,2,1,3,2,22,0,2,20000, 10}  //cumple condicion
    };

    eph_i ti_esperado = {
            {15726,2018,1,0,3,2,50,1,3,10000,0},
            {15726,2018,2,0,3,1,47,1,3,10000,5},
            {15726,2018,3,1,3,1,27,1,1,18000,8},
            {15726,2018,4,0,3,1,26,1,3,16000,5},
            {15726,2018,5,0,3,2,19,0,0,0,    10},
            {188,  2018,2,0,3,1,71,0,0,7000,  10},
            {188,  2018,3,1,3,1,39,1,2,2000,  9},
            {188,  2018,4,0,3,1,36,0,0,0,     10},
            {188,  2018,5,0,3,1,29,1,2,1000,  8},
            {188,  2018,6,0,3,1,10,0,0,0,     10},
            {11867,2018,1,1,3,1,26,1,3,21000, 1},
    };

    eph_i res_ti_esperado = {
            {15726,2018,6,1,3,2,3, 0,0,0,     10}, //cumple condicion
            {188,  2018,1,1,3,2,60,0,0,6000,  10}, //cumple condicion
            {8596, 2018,1,1,3,2,56,1,3,18000, 10}, //cumple condicion
            {11867,2018,2,1,3,2,22,0,2,20000, 10}  //cumple condicion
    };

    eph_h res_th_esperado = {
            {15726,2018,3,336630,646391,2,40,1,1,3,3,2},
            {188,  2018,3,325187,635309,3,40,0,1,3,2,2},
            {8596, 2018,3,336582,646678,2,40,1,1,1,1,2},
            {11867,2018,3,320329,630940,1,43,1,1,3,2,2}
    };
    vector<pair<int, dato>> busqueda = {
            {PP04G, 10}, {NIVEL_ED, 1}, {CH4, 2}
    };

    pair<eph_h, eph_i> res = quitarIndividuos(ti, th, busqueda);


    EXPECT_EQ(th_esperado, th);
    EXPECT_EQ(ti_esperado, ti);

    EXPECT_EQ(res_th_esperado, res.first);
    EXPECT_EQ(res_ti_esperado, res.second);

}

TEST(quitarIndividuosTEST, quitarTodosLosIndividuosDeUnHogarBusquedaDeUnItem) {

    eph_h th = {
            {15726,2018,3,336630,646391,2,40,1,1,3,3,2},
            {188,  2018,3,325187,635309,3,40,0,1,3,2,2},
            {8596, 2018,3,336582,646678,2,40,1,1,1,1,2},
            {11867,2018,3,320329,630940,1,43,1,1,3,2,2}
    };
    eph_h th_esperado = {
            {15726,2018,3,336630,646391,2,40,1,1,3,3,2},
            {8596, 2018,3,336582,646678,2,40,1,1,1,1,2},
            {11867,2018,3,320329,630940,1,43,1,1,3,2,2}
    };

    eph_i ti = {
            {15726,2018,1,0,3,2,50,1,3,10000,0},
            {15726,2018,2,0,3,1,47,1,3,10000,5},
            {15726,2018,3,0,3,1,27,1,1,18000,8},
            {15726,2018,4,0,3,1,26,1,3,16000,5},
            {15726,2018,5,0,3,2,19,0,0,0,    10},
            {15726,2018,6,0,3,2,3, 0,0,0,     10},
            {188,  2018,1,0,3,2,60,0,0,6000,  10},
            {188,  2018,2,0,3,1,71,0,0,7000,  10},
            {188,  2018,3,0,3,1,39,1,2,2000,  9},
            {188,  2018,4,0,3,1,36,0,0,0,     10},
            {188,  2018,5,0,3,1,29,1,2,1000,  8},
            {188,  2018,6,0,3,1,10,0,0,0,     10},
            {8596, 2018,1,0,3,2,56,1,3,18000, 1},
            {11867,2018,1,1,3,1,26,1,3,21000, 1},
            {11867,2018,2,0,3,2,22,0,2,20000, 10}
    };

    eph_i ti_esperado = {
            {15726,2018,1,0,3,2,50,1,3,10000,0},
            {15726,2018,2,0,3,1,47,1,3,10000,5},
            {15726,2018,3,0,3,1,27,1,1,18000,8},
            {15726,2018,4,0,3,1,26,1,3,16000,5},
            {15726,2018,5,0,3,2,19,0,0,0,    10},
            {15726,2018,6,0,3,2,3, 0,0,0,     10},
            {8596, 2018,1,0,3,2,56,1,3,18000, 1},
            {11867,2018,1,1,3,1,26,1,3,21000, 1},
            {11867,2018,2,0,3,2,22,0,2,20000, 10}
    };

    eph_i res_ti_esperado = {
            {188,  2018,1,0,3,2,60,0,0,6000,  10},
            {188,  2018,2,0,3,1,71,0,0,7000,  10},
            {188,  2018,3,0,3,1,39,1,2,2000,  9},
            {188,  2018,4,0,3,1,36,0,0,0,     10},
            {188,  2018,5,0,3,1,29,1,2,1000,  8},
            {188,  2018,6,0,3,1,10,0,0,0,     10}
    };

    eph_h res_th_esperado = {
            {188,  2018,3,325187,635309,3,40,0,1,3,2,2}
    };

    vector<pair<int, dato>> busqueda = {
            {INDCODUSU, 188}
    };

    pair<eph_h, eph_i> res = quitarIndividuos(ti, th, busqueda);


    EXPECT_EQ(th_esperado, th);
    EXPECT_EQ(ti_esperado, ti);

    EXPECT_EQ(res_th_esperado, res.first);
    EXPECT_EQ(res_ti_esperado, res.second);

}
